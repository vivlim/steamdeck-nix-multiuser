#! /usr/bin/env nix-shell
#! nix-shell x11docker-deps.nix -i /usr/bin/bash

help()
{
  echo "usage: x11docker [ -i | --image ] (image name)"
  echo "                 [ -s | --stdin ] # build image based on stdin, overrides -i"
  echo "                 [ -p | --just-call-podman ] # just call podman instead of doing anything else, passes any args after --"
  echo "                 [ -n | --no-pull-or-build ] # don't try to build or pull the image, just hope it exists."
  exit 2
}

SHORT=i:,s,h,p,n
LONG=image:,stdin,help,just-call-podman,no-pull-or-build
OPTS=$(getopt --alternative --name x11docker --options $SHORT --longoptions $LONG -- "$@")

if [ $# -eq 0 ]; then
  help
fi

eval set -- "$OPTS"

while :
do
  case "$1" in
    -i | --image )
      IMAGE="$2"
      shift 2
      ;;
    -h | --help)
      help
      ;;
    -s | --stdin)
      USE_STDIN="yup"
      shift;
      ;;
    -p | --just-call-podman )
      JUST_CALL_PODMAN="mmhmm"
      shift;
      ;;
    -n | --no-pull-or-build )
      NO_PULL_OR_BUILD="yup"
      shift;
      ;;
    --)
      shift;
      break
      ;;
    *)
      echo "unknown option: $1"
      help
      ;;
  esac
done

if [[ "$JUST_CALL_PODMAN" == "mmhmm" ]]; then
    podman $@
    exit $#
fi

if [ -z "$IMAGE" ] && [ -z "$USE_STDIN" ]; then
    echo "No image specified. Perhaps try -i x11docker/xfce?"
    help
fi

#buildah info
#exit 0

if [ -z $NO_PULL_OR_BUILD ]; then
    if [[ "$USE_STDIN" ]]; then
        IMAGE="local/stdin-image"
        echo "using stdin dockerfile"
        cat | podman build - -t "$IMAGE"
        IMAGE="localhost/$IMAGE" # podman prefixes with repository name, and in this case, that's localhost
    fi
    if [ $? -ne 0 ]; then
        echo "there was a problem building or pulling the container image, aborting."
        exit $?
    fi
else
    if [[ "$USE_STDIN" ]]; then
        IMAGE="localhost/local/stdin-image"
    fi
fi

# we have to pass --userns=host because podman in rootful mode refuses to run with --userns=keep-id!
# but x11docker assumes that --userns=keep-id is a valid option to pass to podman, even in rootful mode.
nixGLIntel x11docker --backend=podman "$@" -- --userns=host -- "$IMAGE"
